name: Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Run every Monday at 2 AM

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install client dependencies
      run: cd client && npm ci
    
    - name: Run npm audit for server
      run: |
        echo "## 🔒 Security Audit Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Server Dependencies" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        npm audit --audit-level=low >> $GITHUB_STEP_SUMMARY || true
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Run npm audit for client
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Client Dependencies" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cd client && npm audit --audit-level=low >> $GITHUB_STEP_SUMMARY || true
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Check for hardcoded secrets
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔍 Secret Detection" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        # Check for potential secrets (basic patterns)
        grep -r -i "password\|secret\|key\|token" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" . | grep -v node_modules | grep -v ".git" | head -20 || echo "No obvious secrets found"
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Check dependencies for known vulnerabilities
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📦 Dependency Analysis" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "Server dependencies with vulnerabilities:"
        npm audit --json | jq -r '.vulnerabilities | keys[]' 2>/dev/null || echo "No vulnerabilities detected"
        echo ""
        echo "Client dependencies with vulnerabilities:"
        cd client && npm audit --json | jq -r '.vulnerabilities | keys[]' 2>/dev/null || echo "No vulnerabilities detected"
        echo '```' >> $GITHUB_STEP_SUMMARY
