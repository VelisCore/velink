<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings - Velink</title>
  <link rel="icon" href="/img/logo/fresh/white_purple_rounded.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/css/dashboard.css" rel="stylesheet" />
  <link href="/css/dashboard_layout.css" rel="stylesheet" />
  <style>
    .settings-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e1e5e9;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .settings-header {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 1px solid #e1e5e9;
    }
    .settings-body {
      padding: 20px;
    }
    .form-floating > label {
      padding-left: 0.75rem;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    }
    .danger-zone {
      border: 2px solid #dc3545;
      border-radius: 12px;
      background: #fff5f5;
    }
    .danger-zone .settings-header {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <nav>
    <a class="logo_link" href="/"><div class="logo">Velink</div></a>
    <button class="menu-toggle" aria-label="Toggle menu">&#9776;</button>
    
    <ul class="nav-links">
        <a href="/manage" class="nav-item"><i class="bi bi-link-45deg"></i> Links</a>
        <a href="/feed" class="nav-item"><i class="bi bi-rss"></i> News</a>
        <a href="/profile/<%= username %>" class="nav-item"><i class="bi bi-person"></i> Profile</a>
        <a href="/settings" class="nav-item active"><i class="bi bi-gear"></i> Settings</a>
        <a href="/customize" class="nav-item"><i class="bi bi-sliders"></i> Customize</a>
        <a href="/analytics" class="nav-item"><i class="bi bi-bar-chart"></i> Analytics</a>
        <% if (user.role === 'admin') { %>
        <a href="/admin" class="nav-item"><i class="bi bi-shield-check"></i> Admin</a>
        <% } %>
        <a href="/logout" class="nav-item logout"><i class="bi bi-box-arrow-right"></i> Logout</a>
    </ul>
  </nav>

  <div class="page-wrapper">
    <aside class="sidebar">
      <div class="nav-section">
        <div class="nav-section-title">Content</div>
        <a href="/manage" class="nav-item"><i class="bi bi-link-45deg"></i> Links</a>
        <a href="/feed" class="nav-item"><i class="bi bi-rss"></i> News</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Account</div>
        <a href="/profile/<%= username %>" class="nav-item"><i class="bi bi-person"></i> Profile</a>
        <a href="/settings" class="nav-item active"><i class="bi bi-gear"></i> Settings</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Customization</div>
        <a href="/customize" class="nav-item"><i class="bi bi-sliders"></i> Customize</a>
        <a href="/analytics" class="nav-item"><i class="bi bi-bar-chart"></i> Analytics</a>
      </div>
      <% if (user.role === 'admin') { %>
      <div class="nav-section">
        <div class="nav-section-title">Admin</div>
        <a href="/admin" class="nav-item"><i class="bi bi-shield-check"></i> Dashboard</a>
      </div>
      <% } %>
    </aside>

    <main class="content">
      <h1>Account Settings</h1>

      <!-- Success/Error Messages -->
      <% if (typeof success !== 'undefined' && success) { %>
        <div class="alert alert-success alert-dismissible fade show">
          <% if (success === 'profile_updated') { %>Profile updated successfully!<% } %>
          <% if (success === 'account_updated') { %>Account settings updated successfully!<% } %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-danger alert-dismissible fade show">
          <% if (error === 'profile_update_failed') { %>Failed to update profile. Please try again.<% } %>
          <% if (error === 'current_password_required') { %>Current password is required.<% } %>
          <% if (error === 'invalid_password') { %>Current password is incorrect.<% } %>
          <% if (error === 'account_update_failed') { %>Failed to update account. Please try again.<% } %>
          <% if (error === 'user_not_found') { %>User not found.<% } %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <!-- Profile Information -->
      <div class="settings-card">
        <div class="settings-header">
          <h3 class="mb-0"><i class="bi bi-person-circle"></i> Profile Information</h3>
          <small class="text-muted">Update your public profile information</small>
        </div>
        <div class="settings-body">
          <form method="POST" action="/settings/profile">
            <div class="row">
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="display_name" name="display_name" 
                         value="<%= profile.display_name || '' %>" placeholder="Display Name">
                  <label for="display_name">Display Name</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="location" name="location" 
                         value="<%= profile.location || '' %>" placeholder="Location">
                  <label for="location">Location</label>
                </div>
              </div>
            </div>

            <div class="form-floating mb-3">
              <textarea class="form-control" id="bio" name="bio" style="height: 100px" 
                        placeholder="Tell people about yourself..."><%= profile.bio || '' %></textarea>
              <label for="bio">Bio</label>
            </div>

            <div class="form-floating mb-3">
              <input type="url" class="form-control" id="website" name="website" 
                     value="<%= profile.website || '' %>" placeholder="https://example.com">
              <label for="website">Website</label>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Update Profile
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Account Settings -->
      <div class="settings-card">
        <div class="settings-header">
          <h3 class="mb-0"><i class="bi bi-shield-lock"></i> Account Security</h3>
          <small class="text-muted">Manage your account credentials</small>
        </div>
        <div class="settings-body">
          <form method="POST" action="/settings/account">
            <div class="row">
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="username" name="username" 
                         value="<%= user.username %>" readonly>
                  <label for="username">Username</label>
                  <div class="form-text">Username cannot be changed</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="email" class="form-control" id="email" name="email" 
                         value="<%= user.email %>" required>
                  <label for="email">Email Address</label>
                </div>
              </div>
            </div>

            <hr class="my-4">

            <h5><i class="bi bi-key"></i> Change Password</h5>
            <p class="text-muted mb-3">Leave password fields empty to keep current password</p>

            <div class="row">
              <div class="col-md-4">
                <div class="form-floating mb-3">
                  <input type="password" class="form-control" id="current_password" name="current_password" 
                         placeholder="Current Password">
                  <label for="current_password">Current Password *</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating mb-3">
                  <input type="password" class="form-control" id="new_password" name="new_password" 
                         placeholder="New Password">
                  <label for="new_password">New Password</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating mb-3">
                  <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                         placeholder="Confirm New Password">
                  <label for="confirm_password">Confirm New Password</label>
                </div>
              </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-shield-check"></i> Update Account
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Account Information -->
      <div class="settings-card">
        <div class="settings-header">
          <h3 class="mb-0"><i class="bi bi-info-circle"></i> Account Information</h3>
          <small class="text-muted">Your account details and statistics</small>
        </div>
        <div class="settings-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <strong>Account ID:</strong> <%= user.id %>
              </div>
              <div class="mb-3">
                <strong>Member Since:</strong> <%= new Date().toLocaleDateString() %>
              </div>
              <div class="mb-3">
                <strong>Account Type:</strong> 
                <span class="badge bg-<%= user.role === 'admin' ? 'danger' : user.role === 'moderator' ? 'warning' : 'secondary' %>">
                  <%= user.role.toUpperCase() %>
                </span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <strong>Profile Views:</strong> <%= profile.profile_views || 0 %>
              </div>
              <div class="mb-3">
                <strong>Public Profile:</strong> 
                <a href="/profile/<%= user.username %>" target="_blank" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-eye"></i> View Profile
                </a>
              </div>
              <div class="mb-3">
                <strong>Profile URL:</strong> 
                <code>velink.me/profile/<%= user.username %></code>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Password confirmation validation
    const newPasswordField = document.getElementById('new_password');
    const confirmPasswordField = document.getElementById('confirm_password');
    
    if (confirmPasswordField) {
      confirmPasswordField.addEventListener('input', function() {
        const newPassword = newPasswordField.value;
        const confirmPassword = this.value;
        
        if (newPassword && confirmPassword && newPassword !== confirmPassword) {
          this.setCustomValidity('Passwords do not match');
        } else {
          this.setCustomValidity('');
        }
      });
    }

    // Menu toggle functionality
    const toggleButton = document.querySelector('.menu-toggle');
    const navLinks = document.querySelector('.nav-links');

    if (toggleButton) {
      toggleButton.addEventListener('click', () => {
        navLinks.classList.toggle('show');
      });
    }
  </script>
</body>
</html>
