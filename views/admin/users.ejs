<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - Admin - Velink</title>
  <link rel="icon" href="/img/logo/fresh/white_purple_rounded.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .admin-sidebar {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .role-badge {
      font-size: 0.8rem;
    }
    .status-active {
      color: #28a745;
    }
    .status-inactive {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 d-md-block admin-sidebar sidebar collapse">
        <div class="position-sticky pt-3">
          <div class="text-center mb-4">
            <h4 class="text-white">Admin Panel</h4>
            <p class="text-white-50">Welcome, <%= user.username %></p>
          </div>
          
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link text-white-50" href="/admin">
                <i class="bi bi-speedometer2"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white active" href="/admin/users">
                <i class="bi bi-people"></i> Users
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white-50" href="/admin/analytics">
                <i class="bi bi-graph-up"></i> Analytics
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white-50" href="/admin/logs">
                <i class="bi bi-journal-text"></i> Logs
              </a>
            </li>
            <li class="nav-item mt-3">
              <a class="nav-link text-white-50" href="/">
                <i class="bi bi-house"></i> Back to Site
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-white-50" href="/logout">
                <i class="bi bi-box-arrow-right"></i> Logout
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- Main content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">User Management</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
              <button type="button" class="btn btn-sm btn-outline-secondary">Export Users</button>
            </div>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Search users..." id="userSearch">
              <button class="btn btn-outline-secondary" type="button">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-6">
            <select class="form-select" id="roleFilter">
              <option value="">All Roles</option>
              <option value="admin">Admin</option>
              <option value="moderator">Moderator</option>
              <option value="user">User</option>
            </select>
          </div>
        </div>

        <!-- Users Table -->
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Users (<%= totalUsers %> total)</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th width="30">
                      <input type="checkbox" class="form-check-input" id="selectAll">
                    </th>
                    <th>User</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% users.forEach(user => { %>
                  <tr>
                    <td>
                      <input type="checkbox" class="form-check-input user-select" data-user-id="<%= user.id %>">
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <img src="/img/default.png" alt="Avatar" class="user-avatar me-2">
                        <div>
                          <strong><%= user.username %></strong>
                          <% if (user.verified) { %>
                            <i class="bi bi-patch-check-fill text-primary ms-1" title="Verified"></i>
                          <% } %>
                          <% if (user.is_banned) { %>
                            <i class="bi bi-ban text-danger ms-1" title="Banned"></i>
                          <% } %>
                        </div>
                      </div>
                    </td>
                    <td><%= user.email %></td>
                    <td>
                      <span class="badge role-badge <%= user.role === 'admin' ? 'bg-danger' : user.role === 'moderator' ? 'bg-warning' : 'bg-secondary' %>">
                        <%= user.role.toUpperCase() %>
                      </span>
                    </td>
                    <td>
                      <% if (user.is_banned) { %>
                        <span class="badge bg-danger">Banned</span>
                      <% } else if (user.is_active) { %>
                        <span class="badge bg-success">Active</span>
                      <% } else { %>
                        <span class="badge bg-secondary">Inactive</span>
                      <% } %>
                    </td>
                    <td><%= user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A' %></td>
                    <td><%= user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never' %></td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <a href="/admin/users/<%= user.id %>/edit" class="btn btn-outline-primary">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="/profile/<%= user.username %>" class="btn btn-outline-info" target="_blank">
                          <i class="bi bi-eye"></i>
                        </a>
                        <% if (user.id != user.id) { %>
                        <button class="btn btn-outline-danger" onclick="deleteUser('<%= user.id %>', '<%= user.username %>')">
                          <i class="bi bi-trash"></i>
                        </button>
                        <% } %>
                      </div>
                    </td>
                  </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>

            <!-- Bulk Actions Bar -->
            <div class="card mb-3" id="bulkActionsCard" style="display: none;">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-md-6">
                    <span id="selectedCount">0</span> users selected
                  </div>
                  <div class="col-md-6 text-end">
                    <form id="bulkActionForm" action="/admin/users/bulk-action" method="POST" class="d-inline">
                      <input type="hidden" name="userIds" id="bulkUserIds">
                      <div class="btn-group">
                        <select name="action" class="form-select form-select-sm" style="width: auto;" required>
                          <option value="">Select Action</option>
                          <option value="activate">Activate</option>
                          <option value="deactivate">Deactivate</option>
                          <option value="delete">Delete</option>
                        </select>
                        <button type="submit" class="btn btn-warning btn-sm" onclick="return confirmBulkAction()">
                          Apply
                        </button>
                      </div>
                    </form>
                    <button type="button" class="btn btn-secondary btn-sm ms-2" onclick="clearSelection()">
                      Clear
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pagination -->
            <% if (totalPages > 1) { %>
            <nav aria-label="User pagination">
              <ul class="pagination justify-content-center">
                <% if (currentPage > 1) { %>
                <li class="page-item">
                  <a class="page-link" href="/admin/users?page=<%= currentPage - 1 %>">Previous</a>
                </li>
                <% } %>
                
                <% for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                  <a class="page-link" href="/admin/users?page=<%= i %>"><%= i %></a>
                </li>
                <% } %>
                
                <% if (currentPage < totalPages) { %>
                <li class="page-item">
                  <a class="page-link" href="/admin/users?page=<%= currentPage + 1 %>">Next</a>
                </li>
                <% } %>
              </ul>
            </nav>
            <% } %>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete user <strong id="deleteUsername"></strong>?</p>
          <p class="text-danger">This action cannot be undone and will delete all user data including links and analytics.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <form id="deleteForm" method="POST" style="display: inline;">
            <button type="submit" class="btn btn-danger">Delete User</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function deleteUser(userId, username) {
      document.getElementById('deleteUsername').textContent = username;
      document.getElementById('deleteForm').action = `/admin/users/${userId}/delete`;
      new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    // Search functionality
    document.getElementById('userSearch').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const rows = document.querySelectorAll('tbody tr');
      
      rows.forEach(row => {
        const username = row.querySelector('strong').textContent.toLowerCase();
        const email = row.querySelectorAll('td')[1].textContent.toLowerCase();
        
        if (username.includes(searchTerm) || email.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });

    // Role filter
    document.getElementById('roleFilter').addEventListener('change', function() {
      const selectedRole = this.value.toLowerCase();
      const rows = document.querySelectorAll('tbody tr');
      
      rows.forEach(row => {
        const roleText = row.querySelector('.role-badge').textContent.toLowerCase();
        
        if (!selectedRole || roleText.includes(selectedRole)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });

    // Bulk actions
    const selectAllCheckbox = document.getElementById('selectAll');
    const userCheckboxes = document.querySelectorAll('tbody .user-checkbox');
    const bulkActionsCard = document.getElementById('bulkActionsCard');
    const selectedCountLabel = document.getElementById('selectedCount');
    const bulkUserIdsInput = document.getElementById('bulkUserIds');

    selectAllCheckbox.addEventListener('change', function() {
      const isChecked = this.checked;
      userCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        checkbox.dispatchEvent(new Event('change'));
      });
    });

    userCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const checkedCheckboxes = document.querySelectorAll('tbody .user-checkbox:checked');
        const count = checkedCheckboxes.length;

        if (count > 0) {
          bulkActionsCard.style.display = '';
          selectedCountLabel.textContent = count;

          const userIds = Array.from(checkedCheckboxes).map(checkbox => checkbox.value);
          bulkUserIdsInput.value = userIds.join(',');
        } else {
          bulkActionsCard.style.display = 'none';
        }
      });
    });

    function confirmBulkAction() {
      const actionSelect = document.querySelector('select[name="action"]');
      const selectedAction = actionSelect.value;

      if (selectedAction === 'delete' && !confirm('Are you sure you want to delete the selected users? This action cannot be undone.')) {
        return false;
      }

      return true;
    }

    function clearSelection() {
      userCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.dispatchEvent(new Event('change'));
      });

      selectAllCheckbox.checked = false;
    }

    // Bulk selection logic
    const selectAll = document.getElementById('selectAll');
    const userCheckboxes = document.querySelectorAll('.user-select');
    const bulkActionsCard = document.getElementById('bulkActionsCard');
    const selectedCount = document.getElementById('selectedCount');
    const bulkUserIds = document.getElementById('bulkUserIds');

    function updateBulkSelection() {
      const checked = Array.from(document.querySelectorAll('.user-select:checked'));
      selectedCount.textContent = checked.length;
      bulkUserIds.value = checked.map(cb => cb.getAttribute('data-user-id')).join(',');
      bulkActionsCard.style.display = checked.length > 0 ? '' : 'none';
    }

    if (selectAll) {
      selectAll.addEventListener('change', function() {
        userCheckboxes.forEach(cb => { cb.checked = selectAll.checked; });
        updateBulkSelection();
      });
    }

    userCheckboxes.forEach(cb => {
      cb.addEventListener('change', updateBulkSelection);
    });

    function clearSelection() {
      userCheckboxes.forEach(cb => { cb.checked = false; });
      if (selectAll) selectAll.checked = false;
      updateBulkSelection();
    }

    function confirmBulkAction() {
      return confirm('Are you sure you want to apply this action to the selected users?');
    }
  </script>
</body>
</html>
